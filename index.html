<!DOCTYPE html>
<html lang="uz" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFlash - Ultra-Smart Learning</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (via CDN for standalone portability) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6',
                            600: '#0d9488',
                            900: '#134e4a',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            surface: '#334155'
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'bounce-sm': 'bounceSmall 0.2s',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 },
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        bounceSmall: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(0.95)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles & Glassmorphism */
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* Card 3D Flip */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Gestures */
        .card-stack {
            transition: transform 0.1s linear;
            cursor: grab;
        }
        .card-stack:active { cursor: grabbing; }
        .card-animating {
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease;
        }
        
        /* Floating Action Button Pulse */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(20, 184, 166, 0); }
            100% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); }
        }
        .fab-pulse { animation: pulse-glow 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-dark-bg dark:text-gray-100 transition-colors duration-300 font-sans h-screen flex flex-col overflow-hidden">

    <!-- App Container -->
    <div id="app" class="flex-1 flex flex-col relative h-full max-w-md mx-auto w-full bg-white dark:bg-dark-bg shadow-2xl overflow-hidden">
        
        <!-- Header -->
        <header class="px-6 pt-12 pb-4 flex justify-between items-center z-20 bg-white/80 dark:bg-dark-bg/80 backdrop-blur-md sticky top-0">
            <div>
                <h1 class="text-2xl font-extrabold bg-gradient-to-r from-brand-500 to-blue-500 bg-clip-text text-transparent">SmartFlash</h1>
                <p id="header-greeting" class="text-xs text-gray-500 dark:text-gray-400 font-medium mt-0.5">Welcome back</p>
            </div>
            <div class="flex gap-3">
                <div class="flex items-center gap-1.5 bg-brand-50 dark:bg-brand-900/30 px-3 py-1 rounded-full border border-brand-100 dark:border-brand-900/50">
                    <i class="fa-solid fa-fire text-orange-500 text-sm"></i>
                    <span id="streak-counter" class="text-sm font-bold text-brand-700 dark:text-brand-400">0</span>
                </div>
                <button onclick="App.toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-gray-300 transition-transform active:scale-95">
                    <i id="theme-icon" class="fa-solid fa-moon"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto overflow-x-hidden relative scroll-smooth no-scrollbar p-6 pb-24">
            <!-- Dynamic Content Injected Here -->
        </main>

        <!-- Navigation Bar -->
        <nav class="absolute bottom-0 w-full glass-panel border-t border-gray-200 dark:border-gray-800 pb-safe z-30">
            <div class="flex justify-around items-center h-16 pb-2">
                <button onclick="App.navigate('home')" class="nav-btn group flex flex-col items-center justify-center w-full h-full text-brand-600 dark:text-brand-400">
                    <i class="fa-solid fa-house text-xl mb-1 transition-transform group-active:scale-90"></i>
                    <span class="text-[10px] font-medium" data-i18n="nav.home">Home</span>
                </button>
                <button onclick="App.navigate('decks')" class="nav-btn group flex flex-col items-center justify-center w-full h-full text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fa-solid fa-layer-group text-xl mb-1 transition-transform group-active:scale-90"></i>
                    <span class="text-[10px] font-medium" data-i18n="nav.decks">Decks</span>
                </button>
                
                <!-- Floating Add Button -->
                <div class="-mt-8">
                    <button onclick="App.openCreator()" class="w-14 h-14 bg-brand-500 hover:bg-brand-600 text-white rounded-full shadow-lg shadow-brand-500/40 flex items-center justify-center transition-transform active:scale-90 fab-pulse">
                        <i class="fa-solid fa-plus text-2xl"></i>
                    </button>
                </div>

                <button onclick="App.navigate('stats')" class="nav-btn group flex flex-col items-center justify-center w-full h-full text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fa-solid fa-chart-pie text-xl mb-1 transition-transform group-active:scale-90"></i>
                    <span class="text-[10px] font-medium" data-i18n="nav.stats">Stats</span>
                </button>
                <button onclick="App.navigate('settings')" class="nav-btn group flex flex-col items-center justify-center w-full h-full text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fa-solid fa-gear text-xl mb-1 transition-transform group-active:scale-90"></i>
                    <span class="text-[10px] font-medium" data-i18n="nav.settings">Settings</span>
                </button>
            </div>
            <!-- Footer Attribution -->
            <div class="w-full text-center py-1 bg-gray-50 dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800">
                <p class="text-[10px] text-gray-400 font-medium tracking-wide">Â© Muhammad Daler tomonidan yasalgan</p>
            </div>
        </nav>

        <!-- Overlay Modals -->
        <div id="modal-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300" onclick="App.closeModal()"></div>
        
        <!-- Creator Modal -->
        <div id="creator-modal" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card rounded-t-3xl p-6 z-50 transform translate-y-full transition-transform duration-300 max-w-md mx-auto shadow-2xl border-t border-gray-100 dark:border-gray-700 h-[85vh] flex flex-col">
            <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-6"></div>
            <h2 class="text-xl font-bold mb-4 dark:text-white" data-i18n="create.title">Yangi Karta Yaratish</h2>
            
            <div class="flex-1 overflow-y-auto no-scrollbar space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1" data-i18n="create.deck">Deck</label>
                    <select id="new-card-deck" class="w-full p-3 bg-gray-50 dark:bg-dark-surface rounded-xl border-none focus:ring-2 focus:ring-brand-500 dark:text-white outline-none">
                        <!-- Decks populated here -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1" data-i18n="create.front">Savol (Front)</label>
                    <textarea id="new-card-front" rows="3" class="w-full p-3 bg-gray-50 dark:bg-dark-surface rounded-xl border-none focus:ring-2 focus:ring-brand-500 dark:text-white outline-none resize-none" placeholder="Enter question..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1" data-i18n="create.back">Javob (Back)</label>
                    <textarea id="new-card-back" rows="3" class="w-full p-3 bg-gray-50 dark:bg-dark-surface rounded-xl border-none focus:ring-2 focus:ring-brand-500 dark:text-white outline-none resize-none" placeholder="Enter answer..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1" data-i18n="create.type">Type</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="Creator.setType('basic')" class="flex-1 py-2 rounded-lg bg-brand-500 text-white text-sm font-medium">Basic</button>
                        <button type="button" onclick="Creator.setType('cloze')" class="flex-1 py-2 rounded-lg bg-gray-100 dark:bg-dark-surface text-gray-600 dark:text-gray-300 text-sm font-medium">Cloze</button>
                    </div>
                </div>
            </div>
            
            <button onclick="Creator.saveCard()" class="w-full mt-4 bg-brand-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-500/30 active:scale-95 transition-transform" data-i18n="create.save">
                Saqlash
            </button>
        </div>

    </div>

    <!-- Scripts -->
    <script>
        /**
         * SmartFlash Logic Core
         * Uses Module Pattern for separation of concerns
         */

        // --- Localization System ---
        const I18n = {
            lang: 'uz', // Default
            translations: {
                uz: {
                    'nav.home': 'Bosh sahifa',
                    'nav.decks': 'To\'plamlar',
                    'nav.stats': 'Statistika',
                    'nav.settings': 'Sozlamalar',
                    'home.due': 'Takrorlash vaqti',
                    'home.start': 'Boshlash',
                    'home.empty': 'Hozircha hammasi bajarildi!',
                    'create.title': 'Yangi Karta',
                    'create.deck': 'To\'plam',
                    'create.front': 'Savol (Front)',
                    'create.back': 'Javob (Back)',
                    'create.save': 'Saqlash',
                    'study.show': 'Javobni ko\'rish',
                    'study.again': 'Qayta',
                    'study.hard': 'Qiyin',
                    'study.good': 'Yaxshi',
                    'study.easy': 'Oson',
                    'stats.level': 'Daraja',
                    'stats.xp': 'XP',
                    'settings.lang': 'Tilni o\'zgartirish',
                    'settings.reset': 'Ma\'lumotlarni o\'chirish'
                },
                en: {
                    'nav.home': 'Home',
                    'nav.decks': 'Decks',
                    'nav.stats': 'Stats',
                    'nav.settings': 'Settings',
                    'home.due': 'Cards Due',
                    'home.start': 'Start Session',
                    'home.empty': 'All caught up!',
                    'create.title': 'New Card',
                    'create.deck': 'Deck',
                    'create.front': 'Front',
                    'create.back': 'Back',
                    'create.save': 'Save Card',
                    'study.show': 'Show Answer',
                    'study.again': 'Again',
                    'study.hard': 'Hard',
                    'study.good': 'Good',
                    'study.easy': 'Easy',
                    'stats.level': 'Level',
                    'stats.xp': 'Total XP',
                    'settings.lang': 'Change Language',
                    'settings.reset': 'Reset Data'
                }
            },
            t(key) {
                return this.translations[this.lang][key] || key;
            },
            setLang(lang) {
                this.lang = lang;
                App.render();
            }
        };

        // --- Data Store (LocalStorage) ---
        const Store = {
            data: {
                user: { xp: 0, level: 1, streak: 0, lastStudyDate: null, settings: { lang: 'uz' } },
                decks: [
                    { id: 'd1', name: 'General Knowledge', color: 'bg-blue-500' },
                    { id: 'd2', name: 'English Vocabulary', color: 'bg-purple-500' }
                ],
                cards: []
            },
            init() {
                const saved = localStorage.getItem('smartflash_db_v1');
                if (saved) {
                    this.data = JSON.parse(saved);
                    I18n.lang = this.data.user.settings.lang || 'uz';
                } else {
                    // Seed initial data
                    this.addCard('d1', 'O\'zbekiston poytaxti?', 'Toshkent');
                    this.addCard('d1', 'HTML nimani anglatadi?', 'HyperText Markup Language');
                    this.addCard('d2', 'Apple tarjimasi?', 'Olma');
                    this.save();
                }
                this.checkStreak();
            },
            save() {
                localStorage.setItem('smartflash_db_v1', JSON.stringify(this.data));
            },
            addCard(deckId, front, back, type = 'basic') {
                const card = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    deckId, front, back, type,
                    srs: { interval: 0, ease: 2.5, reviews: 0, dueDate: Date.now() },
                    created: Date.now()
                };
                this.data.cards.push(card);
                this.save();
            },
            getDueCards() {
                const now = Date.now();
                return this.data.cards.filter(c => c.srs.dueDate <= now);
            },
            checkStreak() {
                const today = new Date().toDateString();
                const last = this.data.user.lastStudyDate;
                if (last !== today) {
                    // Logic to reset if missed a day could go here
                    // Simple logic: if last < yesterday, streak = 0. 
                    // For now, we just track current streak logic in updateStats
                }
            },
            updateStats(xpGain) {
                const today = new Date().toDateString();
                if (this.data.user.lastStudyDate !== today) {
                    this.data.user.streak++;
                    this.data.user.lastStudyDate = today;
                }
                this.data.user.xp += xpGain;
                this.data.user.level = Math.floor(Math.sqrt(this.data.user.xp / 100)) + 1;
                this.save();
                App.updateHeader();
            }
        };

        // --- Spaced Repetition Algorithm (Modified SM-2) ---
        const SRS = {
            calculate(card, quality) {
                // quality: 0 (Again), 3 (Hard), 4 (Good), 5 (Easy)
                let { interval, ease, reviews } = card.srs;

                if (quality === 0) {
                    interval = 0; // Reset
                    reviews = 0;
                } else {
                    if (reviews === 0) interval = 1; // 1 day
                    else if (reviews === 1) interval = 6; // 6 days
                    else interval = Math.round(interval * ease);
                    
                    reviews++;
                }

                // Adjust Ease
                ease = ease + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (ease < 1.3) ease = 1.3;

                // Set new due date (minutes vs days logic simplified for demo)
                // For demo: interval is treated as "minutes" for immediate feedback if interval < 10, else "hours"
                // Production: Use days. 
                // Hybrid approach for this prototype:
                let nextDue = Date.now();
                if (quality === 0) nextDue += 1 * 60 * 1000; // 1 min
                else if (quality === 3) nextDue += 10 * 60 * 1000; // 10 mins
                else nextDue += interval * 24 * 60 * 60 * 1000; // Days

                card.srs = { interval, ease, reviews, dueDate: nextDue };
                Store.save();
                return card;
            }
        };

        // --- Creator Controller ---
        const Creator = {
            currentType: 'basic',
            setType(type) {
                this.currentType = type;
                // update UI active state logic if needed
            },
            saveCard() {
                const deckId = document.getElementById('new-card-deck').value;
                const front = document.getElementById('new-card-front').value;
                const back = document.getElementById('new-card-back').value;
                
                if (!front || !back) return alert('Please fill fields');
                
                Store.addCard(deckId, front, back, this.currentType);
                
                // Clear and close
                document.getElementById('new-card-front').value = '';
                document.getElementById('new-card-back').value = '';
                App.closeModal();
                App.render(); // Refresh home if needed
                
                // Success Toast
                alert('Karta saqlandi!'); // Replace with toast in v2
            }
        };

        // --- Study Mode Controller ---
        const Study = {
            queue: [],
            currentCard: null,
            isFlipped: false,
            
            start() {
                this.queue = Store.getDueCards().sort((a,b) => a.srs.dueDate - b.srs.dueDate);
                if (this.queue.length === 0) return;
                this.next();
            },

            next() {
                if (this.queue.length === 0) {
                    App.navigate('home');
                    return;
                }
                this.currentCard = this.queue[0];
                this.isFlipped = false;
                this.renderCard();
            },

            renderCard() {
                const container = document.getElementById('main-content');
                const c = this.currentCard;
                
                // Cloze Logic
                let displayFront = c.front;
                if(c.type === 'cloze') {
                    // Simple regex for {{c1::Answer}} -> [...]
                    displayFront = displayFront.replace(/{{c1::(.*?)}}/g, '<span class="text-brand-500 font-bold">[...]</span>');
                }

                const html = `
                    <div class="h-full flex flex-col justify-between pt-4">
                        <div class="relative w-full h-[65vh] perspective-1000 group cursor-pointer" onclick="Study.flip()">
                            <div id="flashcard" class="relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-3xl">
                                <!-- Front -->
                                <div class="absolute inset-0 backface-hidden bg-white dark:bg-dark-card border border-gray-100 dark:border-gray-700 rounded-3xl flex flex-col items-center justify-center p-8">
                                    <span class="absolute top-6 left-6 text-xs font-bold text-gray-400 uppercase tracking-widest">Savol</span>
                                    <p class="text-2xl font-bold text-gray-800 dark:text-gray-100 leading-relaxed">${displayFront}</p>
                                </div>
                                <!-- Back -->
                                <div class="absolute inset-0 backface-hidden rotate-y-180 bg-white dark:bg-dark-card border border-brand-100 dark:border-brand-900 rounded-3xl flex flex-col items-center justify-center p-8">
                                    <span class="absolute top-6 left-6 text-xs font-bold text-brand-500 uppercase tracking-widest">Javob</span>
                                    <p class="text-xl text-gray-600 dark:text-gray-300 mb-4">${c.front}</p>
                                    <div class="w-12 h-1 bg-gray-200 rounded-full mb-6"></div>
                                    <p class="text-2xl font-bold text-brand-600 dark:text-brand-400 leading-relaxed">${c.back}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div id="study-controls" class="h-24 flex items-center justify-center">
                            <button onclick="Study.flip()" class="w-full bg-gray-900 dark:bg-white dark:text-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">
                                ${I18n.t('study.show')}
                            </button>
                        </div>
                        
                        <div id="answer-buttons" class="hidden h-24 grid-cols-4 gap-2">
                            <button onclick="Study.answer(0)" class="flex flex-col items-center justify-center bg-red-100 dark:bg-red-900/30 text-red-600 rounded-2xl active:scale-95 transition">
                                <span class="text-sm font-bold">${I18n.t('study.again')}</span>
                                <span class="text-[10px] opacity-70">1m</span>
                            </button>
                            <button onclick="Study.answer(3)" class="flex flex-col items-center justify-center bg-orange-100 dark:bg-orange-900/30 text-orange-600 rounded-2xl active:scale-95 transition">
                                <span class="text-sm font-bold">${I18n.t('study.hard')}</span>
                                <span class="text-[10px] opacity-70">10m</span>
                            </button>
                            <button onclick="Study.answer(4)" class="flex flex-col items-center justify-center bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-2xl active:scale-95 transition">
                                <span class="text-sm font-bold">${I18n.t('study.good')}</span>
                                <span class="text-[10px] opacity-70">1d</span>
                            </button>
                            <button onclick="Study.answer(5)" class="flex flex-col items-center justify-center bg-green-100 dark:bg-green-900/30 text-green-600 rounded-2xl active:scale-95 transition">
                                <span class="text-sm font-bold">${I18n.t('study.easy')}</span>
                                <span class="text-[10px] opacity-70">4d</span>
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                
                // Initialize Swipe Gestures
                this.initGestures();
            },

            flip() {
                if (this.isFlipped) return;
                this.isFlipped = true;
                document.getElementById('flashcard').classList.add('rotate-y-180');
                document.getElementById('study-controls').classList.add('hidden');
                document.getElementById('answer-buttons').classList.remove('hidden');
                document.getElementById('answer-buttons').classList.add('grid');
            },

            answer(quality) {
                // Remove from queue
                this.queue.shift();
                
                // Update SRS
                SRS.calculate(this.currentCard, quality);
                
                // Gamification
                let xp = quality === 5 ? 15 : quality === 4 ? 10 : 2;
                Store.updateStats(xp);

                // Animation out
                const cardEl = document.getElementById('flashcard').parentElement;
                cardEl.classList.add('animate-slide-up'); // Actually slide out
                
                setTimeout(() => {
                    this.next();
                }, 200);
            },

            initGestures() {
                const el = document.getElementById('flashcard');
                let startX = 0;
                let currentX = 0;

                el.addEventListener('touchstart', e => {
                    if (!this.isFlipped) return; // Only swipe after flip
                    startX = e.touches[0].clientX;
                    el.style.transition = 'none';
                }, {passive: true});

                el.addEventListener('touchmove', e => {
                    if (!this.isFlipped) return;
                    currentX = e.touches[0].clientX;
                    let diff = currentX - startX;
                    el.style.transform = `rotateY(180deg) translateX(${diff}px) rotateZ(${diff * 0.05}deg)`;
                    
                    // Visual feedback could go here (change border color)
                }, {passive: true});

                el.addEventListener('touchend', e => {
                    if (!this.isFlipped) return;
                    let diff = currentX - startX;
                    el.style.transition = 'transform 0.3s ease';
                    
                    if (diff > 100) {
                        // Swipe Right (Good/Easy)
                        el.style.transform = `rotateY(180deg) translateX(500px)`;
                        this.answer(4);
                    } else if (diff < -100) {
                        // Swipe Left (Again/Hard)
                        el.style.transform = `rotateY(180deg) translateX(-500px)`;
                        this.answer(0);
                    } else {
                        // Reset
                        el.style.transform = `rotateY(180deg)`;
                    }
                });
            }
        };

        // --- View Renderer ---
        const App = {
            currentPage: 'home',

            init() {
                Store.init();
                this.render();
                this.updateHeader();
                
                // Check theme preference
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('theme-icon').className = 'fa-solid fa-sun';
                }
            },

            navigate(page) {
                // Update Active Nav State
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-brand-600', 'dark:text-brand-400'));
                // Simple hack for active state, in prod use unique IDs
                
                this.currentPage = page;
                this.render();
            },

            updateHeader() {
                document.getElementById('streak-counter').innerText = Store.data.user.streak;
            },

            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                if (document.documentElement.classList.contains('dark')) {
                    localStorage.theme = 'dark';
                    document.getElementById('theme-icon').className = 'fa-solid fa-sun';
                } else {
                    localStorage.theme = 'light';
                    document.getElementById('theme-icon').className = 'fa-solid fa-moon';
                }
            },

            openCreator() {
                const modal = document.getElementById('creator-modal');
                const overlay = document.getElementById('modal-overlay');
                const deckSelect = document.getElementById('new-card-deck');
                
                // Populate decks
                deckSelect.innerHTML = Store.data.decks.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                
                modal.style.transform = 'translateY(0)';
            },

            closeModal() {
                const modal = document.getElementById('creator-modal');
                const overlay = document.getElementById('modal-overlay');
                
                modal.style.transform = 'translateY(100%)';
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            },

            render() {
                const container = document.getElementById('main-content');
                container.innerHTML = '';
                container.className = 'flex-1 overflow-y-auto overflow-x-hidden relative scroll-smooth no-scrollbar p-6 pb-24 animate-fade-in';

                // --- HOME PAGE ---
                if (this.currentPage === 'home') {
                    const dueCount = Store.getDueCards().length;
                    
                    const html = `
                        <!-- Progress Card -->
                        <div class="glass-panel rounded-3xl p-6 mb-8 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-brand-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                            <div class="relative z-10">
                                <h2 class="text-3xl font-extrabold text-gray-800 dark:text-white mb-1">${dueCount}</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 uppercase tracking-wider font-semibold">${I18n.t('home.due')}</p>
                                
                                ${dueCount > 0 ? `
                                    <button onclick="Study.start()" class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white font-bold rounded-2xl shadow-lg shadow-brand-500/30 flex items-center justify-center gap-2 transition-all active:scale-95">
                                        <i class="fa-solid fa-play"></i>
                                        ${I18n.t('home.start')}
                                    </button>
                                ` : `
                                    <div class="w-full py-4 bg-gray-100 dark:bg-gray-800 text-gray-400 rounded-2xl flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-check-circle"></i>
                                        ${I18n.t('home.empty')}
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Decks Grid Preview -->
                        <div class="grid grid-cols-2 gap-4">
                            ${Store.data.decks.map(deck => {
                                const count = Store.data.cards.filter(c => c.deckId === deck.id).length;
                                return `
                                <div class="glass rounded-2xl p-4 flex flex-col justify-between h-32 hover:bg-white/50 transition">
                                    <div class="w-10 h-10 ${deck.color} rounded-full flex items-center justify-center text-white text-lg shadow-md">
                                        <i class="fa-solid fa-book"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800 dark:text-gray-200 text-sm leading-tight mb-1">${deck.name}</h3>
                                        <p class="text-xs text-gray-400">${count} cards</p>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    container.innerHTML = html;
                }

                // --- DECKS PAGE ---
                else if (this.currentPage === 'decks') {
                    const html = `
                        <h2 class="text-2xl font-bold mb-6 dark:text-white">${I18n.t('nav.decks')}</h2>
                        <div class="space-y-4">
                            ${Store.data.decks.map(deck => {
                                const count = Store.data.cards.filter(c => c.deckId === deck.id).length;
                                return `
                                <div class="bg-white dark:bg-dark-card p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 ${deck.color} rounded-xl flex items-center justify-center text-white text-xl shadow-lg shadow-brand-500/20">
                                            <i class="fa-solid fa-layer-group"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-lg dark:text-white">${deck.name}</h3>
                                            <p class="text-xs text-gray-400 font-medium">${count} cards</p>
                                        </div>
                                    </div>
                                    <button class="w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-gray-400">
                                        <i class="fa-solid fa-chevron-right"></i>
                                    </button>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    container.innerHTML = html;
                }

                // --- STATS PAGE ---
                else if (this.currentPage === 'stats') {
                    const u = Store.data.user;
                    container.innerHTML = `
                        <h2 class="text-2xl font-bold mb-6 dark:text-white">${I18n.t('nav.stats')}</h2>
                        
                        <div class="bg-gradient-to-br from-brand-500 to-cyan-600 rounded-3xl p-6 text-white mb-6 shadow-xl relative overflow-hidden">
                            <i class="fa-solid fa-trophy absolute -bottom-4 -right-4 text-9xl text-white opacity-10"></i>
                            <div class="relative z-10">
                                <p class="text-brand-100 font-medium text-sm mb-1">${I18n.t('stats.level')}</p>
                                <h1 class="text-5xl font-black mb-4">${u.level}</h1>
                                <div class="w-full bg-black/20 h-2 rounded-full overflow-hidden mb-2">
                                    <div class="bg-white h-full" style="width: ${(u.xp % 100)}%"></div>
                                </div>
                                <p class="text-xs text-brand-100 text-right">${u.xp} XP Total</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white dark:bg-dark-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800">
                                <i class="fa-solid fa-fire text-orange-500 text-2xl mb-2"></i>
                                <h3 class="text-2xl font-bold dark:text-white">${u.streak}</h3>
                                <p class="text-xs text-gray-400">Day Streak</p>
                            </div>
                            <div class="bg-white dark:bg-dark-card p-4 rounded-2xl border border-gray-100 dark:border-gray-800">
                                <i class="fa-solid fa-brain text-purple-500 text-2xl mb-2"></i>
                                <h3 class="text-2xl font-bold dark:text-white">${Store.data.cards.length}</h3>
                                <p class="text-xs text-gray-400">Total Cards</p>
                            </div>
                        </div>
                    `;
                }

                // --- SETTINGS PAGE ---
                else if (this.currentPage === 'settings') {
                    container.innerHTML = `
                        <h2 class="text-2xl font-bold mb-6 dark:text-white">${I18n.t('nav.settings')}</h2>
                        <div class="space-y-4">
                            <div class="bg-white dark:bg-dark-card p-4 rounded-2xl flex items-center justify-between border border-gray-100 dark:border-gray-800">
                                <span class="font-medium dark:text-gray-200">${I18n.t('settings.lang')}</span>
                                <div class="flex gap-2">
                                    <button onclick="I18n.setLang('uz')" class="px-3 py-1 rounded-lg ${I18n.lang === 'uz' ? 'bg-brand-500 text-white' : 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400'} text-xs font-bold">UZ</button>
                                    <button onclick="I18n.setLang('en')" class="px-3 py-1 rounded-lg ${I18n.lang === 'en' ? 'bg-brand-500 text-white' : 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400'} text-xs font-bold">EN</button>
                                </div>
                            </div>
                             <div class="bg-white dark:bg-dark-card p-4 rounded-2xl flex items-center justify-between border border-gray-100 dark:border-gray-800">
                                <span class="font-medium dark:text-gray-200 text-red-500">${I18n.t('settings.reset')}</span>
                                <button onclick="localStorage.clear(); location.reload()" class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-500">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // Start Application
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

    </script>
</body>
</html>

