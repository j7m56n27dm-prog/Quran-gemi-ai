<!DOCTYPE html>
<html lang="uz" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultra Anki Pro - 2025</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Inter & JetBrains Mono -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        ios: { blue: '#007AFF', green: '#34C759', indigo: '#5856D6', orange: '#FF9500', pink: '#FF2D55', purple: '#AF52DE', red: '#FF3B30', teal: '#5AC8FA', yellow: '#FFCC00', gray: '#8E8E93', gray2: '#AEAEB2', gray3: '#C7C7CC', gray4: '#D1D1D6', gray5: '#E5E5EA', gray6: '#F2F2F7' },
                        dark: { bg: '#000000', surface: '#1C1C1E', surface2: '#2C2C2E', border: '#38383A' }
                    },
                    boxShadow: { 'glow': '0 0 20px rgba(0, 122, 255, 0.5)', 'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.3)' }
                }
            }
        }
    </script>

    <style>
        /* --- CORE VISUALS --- */
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; background-color: #000; color: #fff; overflow: hidden; }
        
        /* Glassmorphism */
        .glass { background: rgba(28, 28, 30, 0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-light { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(0, 0, 0, 0.05); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #38383A; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .animate-enter { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-slide { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* 3D Card */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Utilities */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .cloze { color: #007AFF; font-weight: 700; background: rgba(0, 122, 255, 0.1); padding: 2px 6px; border-radius: 4px; }
        
        /* Heatmap Grid */
        .heatmap-grid { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 3px; }
        .heatmap-cell { width: 10px; height: 10px; border-radius: 2px; background-color: #2C2C2E; }
        .heatmap-cell[data-level="1"] { background-color: #0d47a1; }
        .heatmap-cell[data-level="2"] { background-color: #1565c0; }
        .heatmap-cell[data-level="3"] { background-color: #1976d2; }
        .heatmap-cell[data-level="4"] { background-color: #42a5f5; }
    </style>
</head>
<body class="text-white h-[100dvh] w-full flex flex-col selection:bg-ios-blue selection:text-white">

    <!-- APP WRAPPER -->
    <div id="app" class="flex-1 flex flex-col relative w-full h-full max-w-2xl mx-auto bg-dark-bg border-x border-dark-border shadow-2xl overflow-hidden">
        
        <!-- DYNAMIC HEADER -->
        <header id="app-header" class="h-14 px-4 flex items-center justify-between glass z-50 absolute top-0 w-full transition-all duration-300">
            <!-- Injected via JS -->
        </header>

        <!-- MAIN VIEWPORT -->
        <main id="viewport" class="flex-1 overflow-y-auto overflow-x-hidden pt-16 pb-24 px-4 relative scroll-smooth">
            <!-- Views Injected Here -->
        </main>

        <!-- TAB BAR (iOS Style) -->
        <nav class="h-[80px] glass fixed bottom-0 w-full max-w-2xl z-50 flex items-start justify-around pt-3 border-t border-white/10 safe-bottom">
            <button onclick="Router.nav('decks')" class="nav-btn group flex flex-col items-center gap-1 w-16" data-tab="decks">
                <div class="text-2xl transition-transform group-active:scale-90 text-ios-blue"><i class="fa-solid fa-layer-group"></i></div>
                <span class="text-[10px] font-medium text-ios-blue">To'plamlar</span>
            </button>
            <button onclick="Router.nav('add')" class="nav-btn group flex flex-col items-center gap-1 w-16" data-tab="add">
                <div class="w-10 h-10 bg-ios-blue rounded-full flex items-center justify-center text-white text-xl shadow-glow transition-transform group-active:scale-90"><i class="fa-solid fa-plus"></i></div>
                <span class="text-[10px] font-medium text-gray-400">Yaratish</span>
            </button>
            <button onclick="Router.nav('profile')" class="nav-btn group flex flex-col items-center gap-1 w-16" data-tab="profile">
                <div class="text-2xl transition-transform group-active:scale-90 text-gray-500"><i class="fa-solid fa-chart-pie"></i></div>
                <span class="text-[10px] font-medium text-gray-500">Profil</span>
            </button>
        </nav>

        <!-- SETTINGS OVERLAY -->
        <div id="settings-modal" class="fixed inset-0 z-[60] hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="UI.toggleSettings(false)"></div>
            <div class="absolute right-0 top-0 bottom-0 w-3/4 max-w-sm bg-dark-surface border-l border-dark-border shadow-2xl transform transition-transform duration-300 translate-x-full" id="settings-panel">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-6">Sozlamalar</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Ko'rinish</label>
                            <div class="mt-2 flex bg-dark-surface2 rounded-lg p-1">
                                <button class="flex-1 py-2 rounded-md bg-dark-surface text-white text-xs font-bold shadow-sm">Dark</button>
                                <button class="flex-1 py-2 rounded-md text-gray-400 text-xs hover:text-white" onclick="alert('Light mode is deprecated in Pro version')">Light</button>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Ma'lumotlar</label>
                            <button onclick="DataMgr.export()" class="w-full mt-2 py-3 bg-dark-surface2 hover:bg-dark-border rounded-xl text-left px-4 text-sm font-medium flex items-center gap-3 transition">
                                <i class="fa-solid fa-download text-ios-blue"></i> Zaxira nusxa olish (JSON)
                            </button>
                            <button onclick="DataMgr.reset()" class="w-full mt-2 py-3 bg-red-900/20 hover:bg-red-900/30 text-red-500 rounded-xl text-left px-4 text-sm font-medium flex items-center gap-3 transition">
                                <i class="fa-solid fa-trash"></i> Barchasini o'chirish
                            </button>
                        </div>

                         <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Haqida</label>
                            <p class="text-xs text-gray-400 mt-2">Ultra Anki Pro v2.5.0<br>Engine: SM-2 Enhanced<br>© Muhammad Daler</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- LOGIC ENGINE -->
    <script>
        /**
         * ULTRA ANKI PRO ENGINE
         * Architected for Performance & Reliability
         */

        // --- 1. CORE DATABASE MANAGER ---
        const DB = {
            key: 'ultra_anki_pro_db',
            state: {
                user: { xp: 0, level: 1, streak: 0, lastStudy: null, heatmap: {} },
                decks: [], 
                cards: [],
                settings: { cardsPerDay: 20 }
            },

            init() {
                const loaded = localStorage.getItem(this.key);
                if (loaded) {
                    try {
                        const parsed = JSON.parse(loaded);
                        this.state = { ...this.state, ...parsed }; // Merge to ensure structure
                    } catch (e) {
                        console.error("DB Corrupt:", e);
                        this.seed();
                    }
                } else {
                    this.seed();
                }
                this.checkStreak();
            },

            save() {
                localStorage.setItem(this.key, JSON.stringify(this.state));
            },

            seed() {
                this.state.decks = [
                    { id: 'd1', name: 'Ingliz tili (A1)', color: 'from-blue-500 to-cyan-500', created: Date.now() },
                    { id: 'd2', name: 'Tarix', color: 'from-orange-500 to-red-500', created: Date.now() }
                ];
                this.state.cards = [
                    { id: 'c1', deckId: 'd1', front: 'Apple', back: 'Olma', type: 'basic', srs: this.defaultSRS() },
                    { id: 'c2', deckId: 'd1', front: 'Book', back: 'Kitob', type: 'basic', srs: this.defaultSRS() },
                    { id: 'c3', deckId: 'd1', front: 'O\'zbekiston poytaxti {{c1::Toshkent}} shahridir.', back: '', type: 'cloze', srs: this.defaultSRS() }
                ];
                this.save();
            },

            defaultSRS() {
                return { 
                    interval: 0, // days
                    ease: 2.5,   // multiplier
                    due: Date.now(),
                    reps: 0,
                    lapses: 0,
                    state: 'new' // new, learning, review, relearning
                };
            },

            checkStreak() {
                const today = new Date().toDateString();
                if (this.state.user.lastStudy !== today) {
                    // Logic to maintain or reset streak would go here
                    // For now, simple logic
                }
            },

            logActivity() {
                const today = new Date().toISOString().split('T')[0];
                this.state.user.heatmap[today] = (this.state.user.heatmap[today] || 0) + 1;
                this.state.user.lastStudy = new Date().toDateString();
                this.save();
            }
        };

        // --- 2. ADVANCED SRS ALGORITHM (SM-2 ENHANCED) ---
        const SRS = {
            calc(card, rating) {
                // Rating: 1 (Again), 2 (Hard), 3 (Good), 4 (Easy)
                const now = Date.now();
                let { interval, ease, reps, lapses } = card.srs;

                if (rating === 1) { // Again (Fail)
                    interval = 0; // Reset to 0 days (or minutes in a real queue)
                    reps = 0;
                    lapses++;
                    card.srs.state = 'learning';
                } else {
                    // Success
                    if (reps === 0) {
                        interval = 1; // 1 day
                    } else if (reps === 1) {
                        interval = 6; // 6 days
                    } else {
                        // SM-2 Formula
                        let modifier = 1;
                        if (rating === 2) modifier = 1.2; // Hard penalty
                        if (rating === 4) modifier = 1.3; // Easy bonus
                        
                        interval = Math.round(interval * ease * modifier);
                    }
                    
                    reps++;
                    card.srs.state = 'review';
                }

                // Ease Factor Adjustments
                // SM-2: EF' = EF + (0.1 - (5-q)*(0.08+(5-q)*0.02))
                // Mapped: q=1(Again)->Fail, q=2(Hard), q=3(Good), q=4(Easy)
                // We simplify slightly for stability
                if (rating === 1) ease -= 0.20;
                else if (rating === 2) ease -= 0.15;
                else if (rating === 4) ease += 0.15;
                
                if (ease < 1.3) ease = 1.3; // Floor

                // Calculate Next Due Date
                let addMs = 0;
                if (rating === 1) addMs = 1 * 60 * 1000; // 1 min
                else if (rating === 2) addMs = interval * 0.5 * 24 * 60 * 60 * 1000; // Half normal interval
                else addMs = interval * 24 * 60 * 60 * 1000;

                card.srs = { interval, ease, reps, lapses, due: now + addMs, state: card.srs.state };
                return card;
            },

            getDue(deckId) {
                const now = Date.now();
                return DB.state.cards
                    .filter(c => c.deckId === deckId && c.srs.due <= now)
                    .sort((a,b) => a.srs.due - b.srs.due);
            }
        };

        // --- 3. UI RENDERER & ROUTER ---
        const Router = {
            activeView: 'decks',
            params: {},

            nav(view, params = {}) {
                this.activeView = view;
                this.params = params;
                
                // Update Tab Bar
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const icon = btn.querySelector('div');
                    const label = btn.querySelector('span');
                    if (btn.dataset.tab === view) {
                        icon.classList.add('text-ios-blue');
                        icon.classList.remove('text-gray-500');
                        label.classList.add('text-ios-blue');
                        label.classList.remove('text-gray-500');
                    } else if (btn.dataset.tab !== 'add') {
                         icon.classList.remove('text-ios-blue');
                         icon.classList.add('text-gray-500');
                         label.classList.remove('text-ios-blue');
                         label.classList.add('text-gray-500');
                    }
                });

                this.render();
            },

            render() {
                const container = document.getElementById('viewport');
                const header = document.getElementById('app-header');
                
                // --- DECKS VIEW ---
                if (this.activeView === 'decks') {
                    header.innerHTML = `
                        <h1 class="text-xl font-bold tracking-tight">Kutubxona</h1>
                        <button onclick="UI.toggleSettings(true)" class="text-gray-400 hover:text-white"><i class="fa-solid fa-gear text-lg"></i></button>
                    `;
                    
                    const totalDue = DB.state.decks.reduce((acc, d) => acc + SRS.getDue(d.id).length, 0);

                    let html = `
                        <div class="animate-enter">
                            <!-- Hero Status -->
                            <div class="mb-6 p-5 rounded-3xl bg-gradient-to-br from-dark-surface to-dark-surface2 border border-dark-border relative overflow-hidden">
                                <div class="relative z-10 flex justify-between items-end">
                                    <div>
                                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Takrorlash uchun</p>
                                        <h2 class="text-4xl font-extrabold text-white">${totalDue}</h2>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Streak</p>
                                        <div class="flex items-center gap-1 justify-end">
                                            <i class="fa-solid fa-fire text-orange-500"></i>
                                            <span class="text-xl font-bold">${DB.state.user.streak}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h3 class="text-sm font-bold text-gray-500 mb-3 ml-1 uppercase">To'plamlar</h3>
                            <div class="space-y-3">
                    `;

                    DB.state.decks.forEach(deck => {
                        const due = SRS.getDue(deck.id).length;
                        const total = DB.state.cards.filter(c => c.deckId === deck.id).length;
                        
                        html += `
                            <div onclick="Router.nav('study_intro', {id: '${deck.id}'})" class="group relative overflow-hidden bg-dark-surface hover:bg-dark-surface2 border border-dark-border p-4 rounded-2xl flex items-center justify-between transition-all duration-200 active:scale-[0.98] cursor-pointer">
                                <div class="absolute inset-y-0 left-0 w-1.5 bg-gradient-to-b ${deck.color}"></div>
                                <div class="pl-3">
                                    <h4 class="text-lg font-bold text-white group-hover:text-ios-blue transition-colors">${deck.name}</h4>
                                    <p class="text-xs text-gray-400 font-mono mt-1">${total} karta • <span class="${due > 0 ? 'text-ios-green font-bold' : ''}">${due} due</span></p>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-dark-bg flex items-center justify-center text-gray-500">
                                    <i class="fa-solid fa-chevron-right text-xs"></i>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div></div>`;
                    container.innerHTML = html;
                }

                // --- ADD CARD/DECK VIEW ---
                else if (this.activeView === 'add') {
                    header.innerHTML = `
                        <h1 class="text-xl font-bold">Yaratish</h1>
                        <button onclick="Router.nav('decks')" class="text-ios-blue font-medium text-sm">Bekor qilish</button>
                    `;

                    const deckOptions = DB.state.decks.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

                    container.innerHTML = `
                        <div class="animate-enter space-y-6">
                            
                            <!-- Tabs -->
                            <div class="flex p-1 bg-dark-surface rounded-xl border border-dark-border">
                                <button onclick="UI.toggleAddMode('card')" id="tab-card" class="flex-1 py-2 text-xs font-bold rounded-lg bg-dark-surface2 text-white shadow-sm transition">Karta</button>
                                <button onclick="UI.toggleAddMode('deck')" id="tab-deck" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-400 transition">To'plam</button>
                            </div>

                            <!-- Card Form -->
                            <div id="form-card" class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-2">TO'PLAM</label>
                                    <div class="relative">
                                        <select id="inp-deck" class="w-full appearance-none bg-dark-surface border border-dark-border text-white p-4 rounded-xl outline-none focus:border-ios-blue transition">
                                            ${deckOptions}
                                        </select>
                                        <div class="absolute right-4 top-4 text-gray-400 pointer-events-none"><i class="fa-solid fa-chevron-down"></i></div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-2">KARTA TURI</label>
                                    <div class="flex gap-2 mb-2">
                                        <button onclick="UI.setCardType('basic')" id="btn-type-basic" class="flex-1 py-2 bg-ios-blue/20 text-ios-blue border border-ios-blue/50 rounded-lg text-xs font-bold">Basic</button>
                                        <button onclick="UI.setCardType('cloze')" id="btn-type-cloze" class="flex-1 py-2 bg-dark-surface border border-dark-border text-gray-400 rounded-lg text-xs font-bold">Cloze (bo'shliq)</button>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-2">SAVOL / MATN (FRONT)</label>
                                    <textarea id="inp-front" rows="3" class="w-full bg-dark-surface border border-dark-border text-white p-4 rounded-xl outline-none focus:border-ios-blue transition font-medium text-base resize-none" placeholder="Savolni kiriting..."></textarea>
                                    <p id="help-cloze" class="hidden text-[10px] text-gray-500 mt-1">Yashirish uchun: {{c1::yashirin so'z}}</p>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-2">JAVOB (BACK)</label>
                                    <textarea id="inp-back" rows="3" class="w-full bg-dark-surface border border-dark-border text-white p-4 rounded-xl outline-none focus:border-ios-blue transition font-medium text-base resize-none" placeholder="Javobni kiriting..."></textarea>
                                </div>

                                <button onclick="Actions.addCard()" class="w-full py-4 bg-ios-blue hover:bg-blue-600 text-white font-bold rounded-xl shadow-glow transition active:scale-95">
                                    Qo'shish
                                </button>
                            </div>

                            <!-- Deck Form -->
                            <div id="form-deck" class="hidden space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-2">YANGI TO'PLAM NOMI</label>
                                    <input type="text" id="inp-deck-name" class="w-full bg-dark-surface border border-dark-border text-white p-4 rounded-xl outline-none focus:border-ios-blue transition font-medium" placeholder="Masalan: Fizika">
                                </div>
                                <button onclick="Actions.addDeck()" class="w-full py-4 bg-ios-indigo hover:bg-indigo-600 text-white font-bold rounded-xl shadow-glow transition active:scale-95">
                                    To'plam Yaratish
                                </button>
                            </div>
                        </div>
                    `;
                }

                // --- PROFILE VIEW ---
                else if (this.activeView === 'profile') {
                    header.innerHTML = `<h1 class="text-xl font-bold">Profil</h1><div></div>`;
                    
                    const user = DB.state.user;
                    // Generate Heatmap Data
                    let heatmapHTML = '';
                    const today = new Date();
                    // Simple logic to show last 100 days roughly
                    for(let i=0; i<84; i++) { // 12 weeks * 7
                        const lvl = Math.floor(Math.random() * 5); // Fake data for visual demo if empty
                        // In real app, match date with user.heatmap
                        heatmapHTML += `<div class="heatmap-cell" data-level="${Math.random() > 0.7 ? Math.floor(Math.random()*4)+1 : 0}"></div>`;
                    }

                    container.innerHTML = `
                        <div class="animate-enter">
                            <div class="flex items-center gap-4 mb-8">
                                <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-ios-blue to-ios-purple flex items-center justify-center text-3xl shadow-glow">
                                    <i class="fa-solid fa-user-astronaut"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold">Foydalanuvchi</h2>
                                    <p class="text-sm text-gray-400">Level ${Math.floor(user.xp / 100) + 1} • ${user.xp} XP</p>
                                </div>
                            </div>

                            <div class="glass p-5 rounded-2xl mb-6">
                                <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Faollik (Heatmap)</h3>
                                <div class="heatmap-grid w-full overflow-hidden">
                                    ${heatmapHTML}
                                </div>
                                <div class="flex justify-between text-[10px] text-gray-500 mt-2">
                                    <span>Less</span>
                                    <span>More</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-dark-surface p-4 rounded-2xl border border-dark-border">
                                    <i class="fa-solid fa-fire text-ios-orange mb-2 text-xl"></i>
                                    <h3 class="text-xl font-bold">${user.streak}</h3>
                                    <p class="text-xs text-gray-500">Kunlik Streak</p>
                                </div>
                                <div class="bg-dark-surface p-4 rounded-2xl border border-dark-border">
                                    <i class="fa-solid fa-brain text-ios-pink mb-2 text-xl"></i>
                                    <h3 class="text-xl font-bold">${DB.state.cards.length}</h3>
                                    <p class="text-xs text-gray-500">Jami Kartalar</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // --- STUDY INTRO VIEW ---
                else if (this.activeView === 'study_intro') {
                    const deck = DB.state.decks.find(d => d.id === this.params.id);
                    const due = SRS.getDue(deck.id);
                    
                    header.innerHTML = `
                        <button onclick="Router.nav('decks')" class="text-ios-blue flex items-center gap-1 text-sm font-medium"><i class="fa-solid fa-chevron-left"></i> Orqaga</button>
                        <h1 class="text-sm font-bold opacity-0">Study</h1>
                        <button onclick="Actions.deleteDeck('${deck.id}')" class="text-ios-red"><i class="fa-solid fa-trash"></i></button>
                    `;

                    container.innerHTML = `
                        <div class="h-full flex flex-col justify-center items-center text-center animate-enter">
                            <div class="w-24 h-24 rounded-3xl bg-gradient-to-br ${deck.color} flex items-center justify-center text-4xl shadow-glow mb-6">
                                <i class="fa-solid fa-layer-group"></i>
                            </div>
                            <h2 class="text-3xl font-extrabold mb-2">${deck.name}</h2>
                            <p class="text-gray-400 mb-8">${due.length} ta karta takrorlashga tayyor</p>
                            
                            <button onclick="Study.start('${deck.id}')" class="w-full max-w-xs py-4 bg-ios-blue hover:bg-blue-500 text-white font-bold rounded-2xl shadow-glow text-lg transition active:scale-95 mb-4">
                                Boshlash
                            </button>
                            <button onclick="Router.nav('decks')" class="text-gray-500 font-medium text-sm hover:text-white">Keyinroq</button>
                        </div>
                    `;
                }

                // --- STUDY SESSION (THE CORE) ---
                else if (this.activeView === 'study_session') {
                    header.innerHTML = `
                        <button onclick="if(confirm('Chiqishni xohlaysizmi?')) Router.nav('decks')" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                        <div class="text-xs font-bold text-gray-500"><span id="study-count">0</span> qoldi</div>
                        <div></div>
                    `;
                    
                    // The Card Container
                    container.innerHTML = `
                        <div class="h-full flex flex-col pt-4 pb-4">
                            <!-- Card Area -->
                            <div class="flex-1 relative perspective-1000 group">
                                <div id="active-card" class="w-full h-full relative preserve-3d transition-transform duration-500 rounded-3xl shadow-2xl cursor-pointer" onclick="Study.flip()">
                                    
                                    <!-- FRONT -->
                                    <div class="absolute inset-0 backface-hidden bg-dark-surface border border-dark-border rounded-3xl flex flex-col items-center justify-center p-8 text-center">
                                        <div class="absolute top-4 left-4 flex gap-2">
                                            <span class="px-2 py-1 rounded bg-dark-bg text-[10px] text-gray-500 font-bold uppercase tracking-widest" id="card-tag">SAVOL</span>
                                        </div>
                                        <div id="card-front-content" class="text-2xl md:text-3xl font-medium leading-relaxed"></div>
                                        <p class="absolute bottom-8 text-xs text-gray-500 animate-pulse">Javobni ko'rish uchun bosing</p>
                                    </div>

                                    <!-- BACK -->
                                    <div class="absolute inset-0 backface-hidden rotate-y-180 bg-dark-surface2 border border-dark-border rounded-3xl flex flex-col items-center justify-center p-8 text-center">
                                        <div class="text-gray-400 text-lg mb-6 line-through decoration-ios-blue decoration-2 opacity-50" id="card-front-ref"></div>
                                        <div class="w-16 h-1 bg-dark-border rounded-full mb-6"></div>
                                        <div id="card-back-content" class="text-3xl md:text-4xl font-bold text-white leading-relaxed text-shadow-lg"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Controls Area -->
                            <div class="h-20 mt-6 relative">
                                <!-- Show Answer Button -->
                                <button id="btn-show" onclick="Study.flip()" class="absolute inset-0 w-full bg-ios-blue text-white font-bold rounded-2xl shadow-glow text-lg">
                                    Javobni Ko'rsatish
                                </button>
                                
                                <!-- Grading Buttons (Hidden initially) -->
                                <div id="grading-grid" class="hidden grid-cols-4 gap-3 h-full animate-slide">
                                    <button onclick="Study.rate(1)" class="flex flex-col items-center justify-center bg-dark-surface border border-ios-red/30 text-ios-red rounded-xl hover:bg-ios-red/10 active:scale-95 transition">
                                        <span class="font-bold">Again</span>
                                        <span class="text-[10px] opacity-60">1m</span>
                                    </button>
                                    <button onclick="Study.rate(2)" class="flex flex-col items-center justify-center bg-dark-surface border border-ios-orange/30 text-ios-orange rounded-xl hover:bg-ios-orange/10 active:scale-95 transition">
                                        <span class="font-bold">Hard</span>
                                        <span class="text-[10px] opacity-60">6m</span>
                                    </button>
                                    <button onclick="Study.rate(3)" class="flex flex-col items-center justify-center bg-dark-surface border border-ios-green/30 text-ios-green rounded-xl hover:bg-ios-green/10 active:scale-95 transition">
                                        <span class="font-bold">Good</span>
                                        <span class="text-[10px] opacity-60">10m</span>
                                    </button>
                                    <button onclick="Study.rate(4)" class="flex flex-col items-center justify-center bg-dark-surface border border-ios-blue/30 text-ios-blue rounded-xl hover:bg-ios-blue/10 active:scale-95 transition">
                                        <span class="font-bold">Easy</span>
                                        <span class="text-[10px] opacity-60">4d</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Initialize Keyboard shortcuts for desktop
                    document.onkeydown = (e) => {
                        if (this.activeView !== 'study_session') return;
                        if (e.code === 'Space') { e.preventDefault(); Study.flip(); }
                        if (Study.isFlipped) {
                            if (e.key === '1') Study.rate(1);
                            if (e.key === '2') Study.rate(2);
                            if (e.key === '3') Study.rate(3);
                            if (e.key === '4') Study.rate(4);
                        }
                    };
                }
            }
        };

        // --- 4. STUDY CONTROLLER ---
        const Study = {
            queue: [],
            current: null,
            isFlipped: false,

            start(deckId) {
                this.queue = SRS.getDue(deckId);
                if (this.queue.length === 0) return alert("Kartalar yo'q!");
                Router.nav('study_session');
                this.next();
            },

            next() {
                if (this.queue.length === 0) {
                    alert("Sessiya tugadi!");
                    Router.nav('decks');
                    return;
                }
                this.current = this.queue[0];
                this.isFlipped = false;
                
                // Update UI Counter
                document.getElementById('study-count').innerText = this.queue.length;

                // Render Content
                const frontEl = document.getElementById('card-front-content');
                const refEl = document.getElementById('card-front-ref');
                const backEl = document.getElementById('card-back-content');
                const tagEl = document.getElementById('card-tag');

                // Reset Flip
                document.getElementById('active-card').classList.remove('rotate-y-180');
                document.getElementById('btn-show').classList.remove('hidden');
                document.getElementById('grading-grid').classList.add('hidden');
                document.getElementById('grading-grid').classList.remove('grid');

                // Content Logic (Cloze vs Basic)
                if (this.current.type === 'cloze') {
                    tagEl.innerText = "CLOZE";
                    // Regex to hide c1
                    const text = this.current.front;
                    const clozeRegex = /{{c1::(.*?)}}/g;
                    frontEl.innerHTML = text.replace(clozeRegex, '<span class="cloze">[ ... ]</span>');
                    refEl.innerHTML = text.replace(clozeRegex, '<span class="text-ios-blue">$1</span>');
                    backEl.innerHTML = "To'g'ri javobni tekshiring";
                } else {
                    tagEl.innerText = "BASIC";
                    frontEl.innerText = this.current.front;
                    refEl.innerText = this.current.front;
                    backEl.innerText = this.current.back;
                }
            },

            flip() {
                if (this.isFlipped) return;
                this.isFlipped = true;
                document.getElementById('active-card').classList.add('rotate-y-180');
                document.getElementById('btn-show').classList.add('hidden');
                document.getElementById('grading-grid').classList.remove('hidden');
                document.getElementById('grading-grid').classList.add('grid');
            },

            rate(rating) {
                // Update Data
                const cardIdx = DB.state.cards.findIndex(c => c.id === this.current.id);
                if (cardIdx > -1) {
                    DB.state.cards[cardIdx] = SRS.calc(DB.state.cards[cardIdx], rating);
                    DB.save();
                    DB.logActivity();
                    DB.state.user.xp += (rating * 5); // XP Logic
                }

                // Remove from local queue
                this.queue.shift();
                
                // Visual Transition
                const card = document.getElementById('active-card');
                card.style.transform = 'translateX(-120%) rotateY(180deg)';
                card.style.opacity = '0';
                
                setTimeout(() => {
                    card.style.transition = 'none';
                    card.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        card.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        this.next();
                    }, 50);
                }, 300);
            }
        };

        // --- 5. UI ACTIONS & HELPERS ---
        const UI = {
            createType: 'basic',

            toggleSettings(show) {
                const modal = document.getElementById('settings-modal');
                const panel = document.getElementById('settings-panel');
                if (show) {
                    modal.classList.remove('hidden');
                    setTimeout(() => panel.classList.remove('translate-x-full'), 10);
                } else {
                    panel.classList.add('translate-x-full');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            },

            toggleAddMode(mode) {
                const btnCard = document.getElementById('tab-card');
                const btnDeck = document.getElementById('tab-deck');
                const formCard = document.getElementById('form-card');
                const formDeck = document.getElementById('form-deck');

                if (mode === 'card') {
                    btnCard.classList.replace('text-gray-400', 'text-white');
                    btnCard.classList.add('bg-dark-surface2', 'shadow-sm');
                    btnDeck.classList.remove('bg-dark-surface2', 'shadow-sm', 'text-white');
                    btnDeck.classList.add('text-gray-400');
                    formCard.classList.remove('hidden');
                    formDeck.classList.add('hidden');
                } else {
                    btnDeck.classList.replace('text-gray-400', 'text-white');
                    btnDeck.classList.add('bg-dark-surface2', 'shadow-sm');
                    btnCard.classList.remove('bg-dark-surface2', 'shadow-sm', 'text-white');
                    btnCard.classList.add('text-gray-400');
                    formCard.classList.add('hidden');
                    formDeck.classList.remove('hidden');
                }
            },

            setCardType(type) {
                this.createType = type;
                const btnBasic = document.getElementById('btn-type-basic');
                const btnCloze = document.getElementById('btn-type-cloze');
                const helpCloze = document.getElementById('help-cloze');

                if (type === 'basic') {
                    btnBasic.className = "flex-1 py-2 bg-ios-blue/20 text-ios-blue border border-ios-blue/50 rounded-lg text-xs font-bold";
                    btnCloze.className = "flex-1 py-2 bg-dark-surface border border-dark-border text-gray-400 rounded-lg text-xs font-bold";
                    helpCloze.classList.add('hidden');
                    document.getElementById('inp-back').disabled = false;
                } else {
                    btnCloze.className = "flex-1 py-2 bg-ios-blue/20 text-ios-blue border border-ios-blue/50 rounded-lg text-xs font-bold";
                    btnBasic.className = "flex-1 py-2 bg-dark-surface border border-dark-border text-gray-400 rounded-lg text-xs font-bold";
                    helpCloze.classList.remove('hidden');
                    document.getElementById('inp-back').disabled = true;
                    document.getElementById('inp-back').placeholder = "Cloze turida orqa taraf avtomatik to'ldiriladi";
                }
            }
        };

        const Actions = {
            addDeck() {
                const name = document.getElementById('inp-deck-name').value;
                if (!name) return alert("Nom kiriting!");
                const colors = [
                    'from-blue-500 to-cyan-500', 'from-purple-500 to-pink-500', 
                    'from-orange-500 to-red-500', 'from-green-500 to-teal-500'
                ];
                DB.state.decks.push({
                    id: 'd' + Date.now(),
                    name,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    created: Date.now()
                });
                DB.save();
                Router.nav('decks');
            },

            addCard() {
                const deckId = document.getElementById('inp-deck').value;
                const front = document.getElementById('inp-front').value;
                const back = document.getElementById('inp-back').value;
                
                if (!front) return alert("Savol yozilmadi!");
                if (UI.createType === 'basic' && !back) return alert("Javob yozilmadi!");

                DB.state.cards.push({
                    id: 'c' + Date.now(),
                    deckId,
                    front,
                    back: UI.createType === 'cloze' ? '...' : back,
                    type: UI.createType,
                    srs: DB.defaultSRS()
                });
                DB.save();
                
                // Clear inputs
                document.getElementById('inp-front').value = '';
                document.getElementById('inp-back').value = '';
                alert("Karta qo'shildi!");
            },

            deleteDeck(id) {
                if(!confirm("To'plam o'chirilsinmi?")) return;
                DB.state.decks = DB.state.decks.filter(d => d.id !== id);
                DB.state.cards = DB.state.cards.filter(c => c.deckId !== id);
                DB.save();
                Router.nav('decks');
            }
        };

        const DataMgr = {
            reset() {
                if(confirm("DIQQAT: Barcha ma'lumotlar o'chib ketadi!")) {
                    localStorage.removeItem(DB.key);
                    location.reload();
                }
            },
            export() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB.state));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "ultra_anki_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            DB.init();
            Router.nav('decks');
        });

    </script>
</body>
</html>


